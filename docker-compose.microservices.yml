# Docker Compose for Microservices Architecture
# This file defines the target microservices structure
# Services will be gradually migrated from api-server monolith

name: deepiri-microservices

version: '3.8'

# Minimal logging - logs are automatically cleared and not saved on restart
# max-size: 1MB, max-file: 1 (no rotation), no compression
x-logging: &minimal-logging
  driver: "local"
  options:
    max-size: "1m"      # Only 1MB per file
    max-file: "1"       # Only 1 file (no rotation backup)
    compress: "false"   # No compression (faster cleanup)

services:
  # Infrastructure Services
  mongodb:
    image: mongo:7.0
    container_name: deepiri-mongodb
    restart: unless-stopped
    logging: *minimal-logging
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password}
      MONGO_INITDB_DATABASE: ${MONGO_DB:-deepiri}
    volumes:
      - mongodb_data:/data/db
    networks:
      - deepiri-network

  redis:
    image: redis:7.2-alpine
    container_name: deepiri-redis
    restart: unless-stopped
    logging: *minimal-logging
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD:-redispassword} --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - deepiri-network

  # API Gateway
  api-gateway:
    build:
      context: ./platform-services/backend/deepiri-api-gateway
      dockerfile: Dockerfile
    container_name: deepiri-api-gateway
    restart: unless-stopped
    logging: *minimal-logging
    ports:
      - "5000:5000"
    env_file:
      - .env-k8s/api-gateway.env
    environment:
      # Override or add docker-specific variables here if needed
      PORT: 5000
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
      - redis
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Auth Service
  auth-service:
    build:
      context: ./platform-services/backend/deepiri-auth-service
      dockerfile: Dockerfile
    container_name: deepiri-auth-service
    restart: unless-stopped
    logging: *minimal-logging
    ports:
      - "5001:5001"
    env_file:
      - .env-k8s/auth-service.env
    environment:
      # Override or add docker-specific variables here if needed
      PORT: 5001
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Task Orchestrator Service
  task-orchestrator:
    build:
      context: ./platform-services/backend/deepiri-task-orchestrator
      dockerfile: Dockerfile
    container_name: deepiri-task-orchestrator
    restart: unless-stopped
    logging: *minimal-logging
    ports:
      - "5002:5002"
    env_file:
      - .env-k8s/task-orchestrator.env
    environment:
      # Override or add docker-specific variables here if needed
      PORT: 5002
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Challenge Service
  challenge-service:
    build:
      context: ./platform-services/backend/deepiri-challenge-service
      dockerfile: Dockerfile
    container_name: deepiri-challenge-service
    restart: unless-stopped
    logging: *minimal-logging
    ports:
      - "5003:5003"
    env_file:
      - .env-k8s/challenge-service.env
    environment:
      # Override or add docker-specific variables here if needed
      PORT: 5003
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
      - cyrex
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Engagement Service
  engagement-service:
    build:
      context: ./platform-services/backend/deepiri-engagement-service
      dockerfile: Dockerfile
    container_name: deepiri-engagement-service
    restart: unless-stopped
    logging: *minimal-logging
    ports:
      - "5004:5004"
    env_file:
      - .env-k8s/engagement-service.env
    environment:
      # Override or add docker-specific variables here if needed
      PORT: 5004
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
      - redis
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Platform Analytics Service
  platform-analytics-service:
    build:
      context: ./platform-services/backend/deepiri-platform-analytics-service
      dockerfile: Dockerfile
    container_name: deepiri-platform-analytics-service
    restart: unless-stopped
    logging: *minimal-logging
    ports:
      - "5005:5005"
    env_file:
      - .env-k8s/platform-analytics-service.env
    environment:
      # Override or add docker-specific variables here if needed
      PORT: 5005
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
    networks:
      - deepiri-network
    profiles:
      - microservices

  # External Bridge Service
  external-bridge-service:
    build:
      context: ./platform-services/backend/deepiri-external-bridge-service
      dockerfile: Dockerfile
    container_name: deepiri-external-bridge-service
    restart: unless-stopped
    logging: *minimal-logging
    ports:
      - "5006:5006"
    env_file:
      - .env-k8s/external-bridge-service.env
    environment:
      # Override or add docker-specific variables here if needed
      PORT: 5006
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Notification Service
  notification-service:
    build:
      context: ./platform-services/backend/deepiri-notification-service
      dockerfile: Dockerfile
    container_name: deepiri-notification-service
    restart: unless-stopped
    logging: *minimal-logging
    ports:
      - "5007:5007"
    env_file:
      - .env-k8s/notification-service.env
    environment:
      # Override or add docker-specific variables here if needed
      PORT: 5007
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Realtime Gateway Service
  realtime-gateway:
    build:
      context: ./platform-services/backend/deepiri-realtime-gateway
      dockerfile: Dockerfile
    container_name: deepiri-realtime-gateway
    restart: unless-stopped
    logging: *minimal-logging
    ports:
      - "5008:5008"
    env_file:
      - .env-k8s/realtime-gateway.env
    environment:
      # Override or add docker-specific variables here if needed
      PORT: 5008
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
      - redis
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Python AI Service
  cyrex:
    build:
      context: ./diri-cyrex
      dockerfile: Dockerfile
    container_name: deepiri-cyrex
    restart: unless-stopped
    logging: *minimal-logging
    env_file:
      - .env-k8s/cyrex.env
    environment:
      # Override or add docker-specific variables here if needed
    ports:
      - "8000:8000"
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Cyrex Interface (Frontend)
  cyrex-interface:
    image: node:20-alpine
    container_name: deepiri-cyrex-interface
    restart: unless-stopped
    logging: *minimal-logging
    working_dir: /app
    environment:
      VITE_CYREX_BASE_URL: http://cyrex:8000
      VITE_PORT: 5175
    ports:
      - "5175:5175"
    volumes:
      - ./diri-cyrex/cyrex-interface:/app
      - /app/node_modules
    command: sh -c "npm install --legacy-peer-deps && npm run dev -- --host 0.0.0.0 --port ${VITE_PORT:-5175}"
    depends_on:
      - cyrex
    networks:
      - deepiri-network
    profiles:
      - microservices

volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local

networks:
  deepiri-network:
    driver: bridge

