# Docker Compose for Microservices Architecture
# This file defines the target microservices structure
# Services will be gradually migrated from api-server monolith

name: deepiri-microservices

version: '3.8'

services:
  # Infrastructure Services
  mongodb:
    image: mongo:7.0
    container_name: deepiri-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password}
      MONGO_INITDB_DATABASE: ${MONGO_DB:-deepiri}
    volumes:
      - mongodb_data:/data/db
    networks:
      - deepiri-network

  redis:
    image: redis:7.2-alpine
    container_name: deepiri-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD:-redispassword}
    volumes:
      - redis_data:/data
    networks:
      - deepiri-network

  # API Gateway
  api-gateway:
    build:
      context: ./services/deepiri-api-gateway
      dockerfile: Dockerfile
    container_name: deepiri-api-gateway
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 5000
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
      REDIS_URL: redis://:${REDIS_PASSWORD:-redispassword}@redis:6379
      JWT_SECRET: ${JWT_SECRET:-your_jwt_secret_key_here}
      # Service URLs
      AUTH_SERVICE_URL: http://auth-service:5001
      TASK_ORCHESTRATOR_URL: http://task-orchestrator:5002
      CHALLENGE_SERVICE_URL: http://challenge-service:5003
      ENGAGEMENT_SERVICE_URL: http://engagement-service:5004
      PLATFORM_ANALYTICS_SERVICE_URL: http://platform-analytics-service:5005
      EXTERNAL_BRIDGE_SERVICE_URL: http://external-bridge-service:5006
      NOTIFICATION_SERVICE_URL: http://notification-service:5007
    depends_on:
      - mongodb
      - redis
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Auth Service
  auth-service:
    build:
      context: ./services/deepiri-auth-service
      dockerfile: Dockerfile
    container_name: deepiri-auth-service
    restart: unless-stopped
    ports:
      - "5001:5001"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 5001
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-your_jwt_secret_key_here}
    depends_on:
      - mongodb
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Task Orchestrator Service
  task-orchestrator:
    build:
      context: ./services/deepiri-task-orchestrator
      dockerfile: Dockerfile
    container_name: deepiri-task-orchestrator
    restart: unless-stopped
    ports:
      - "5002:5002"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 5002
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Challenge Service
  challenge-service:
    build:
      context: ./services/deepiri-challenge-service
      dockerfile: Dockerfile
    container_name: deepiri-challenge-service
    restart: unless-stopped
    ports:
      - "5003:5003"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 5003
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
      AI_SERVICE_URL: http://cyrex:8000
    depends_on:
      - mongodb
      - cyrex
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Engagement Service
  engagement-service:
    build:
      context: ./services/deepiri-engagement-service
      dockerfile: Dockerfile
    container_name: deepiri-engagement-service
    restart: unless-stopped
    ports:
      - "5004:5004"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 5004
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
      REDIS_URL: redis://:${REDIS_PASSWORD:-redispassword}@redis:6379
    depends_on:
      - mongodb
      - redis
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Platform Analytics Service
  platform-analytics-service:
    build:
      context: ./services/deepiri-platform-analytics-service
      dockerfile: Dockerfile
    container_name: deepiri-platform-analytics-service
    restart: unless-stopped
    ports:
      - "5005:5005"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 5005
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
    networks:
      - deepiri-network
    profiles:
      - microservices

  # External Bridge Service
  external-bridge-service:
    build:
      context: ./services/deepiri-external-bridge-service
      dockerfile: Dockerfile
    container_name: deepiri-external-bridge-service
    restart: unless-stopped
    ports:
      - "5006:5006"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 5006
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Notification Service
  notification-service:
    build:
      context: ./services/deepiri-notification-service
      dockerfile: Dockerfile
    container_name: deepiri-notification-service
    restart: unless-stopped
    ports:
      - "5007:5007"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 5007
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
    depends_on:
      - mongodb
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Realtime Gateway Service
  realtime-gateway:
    build:
      context: ./services/deepiri-realtime-gateway
      dockerfile: Dockerfile
    container_name: deepiri-realtime-gateway
    restart: unless-stopped
    ports:
      - "5008:5008"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 5008
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DB:-deepiri}?authSource=admin
      REDIS_URL: redis://:${REDIS_PASSWORD:-redispassword}@redis:6379
    depends_on:
      - mongodb
      - redis
    networks:
      - deepiri-network
    profiles:
      - microservices

  # Python AI Service
  cyrex:
    build:
      context: ./diri-cyrex
      dockerfile: Dockerfile
    container_name: deepiri-cyrex
    restart: unless-stopped
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      NODE_BACKEND_URL: http://api-gateway:5000
      CYREX_API_KEY: ${CYREX_API_KEY:-change-me}
    ports:
      - "8000:8000"
    networks:
      - deepiri-network
    profiles:
      - microservices

volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local

networks:
  deepiri-network:
    driver: bridge

