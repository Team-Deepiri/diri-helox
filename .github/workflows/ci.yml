name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install root dependencies
        run: npm ci
      
      - name: Install deepiri-core-api dependencies
        run: |
          cd deepiri-core-api
          npm ci
      
      - name: Install deepiri-web-frontend dependencies
        run: |
          cd deepiri-web-frontend
          npm ci
      
      - name: Install platform-services dependencies
        run: |
          npm ci --workspace=platform-services/backend/* --workspace=platform-services/shared/deepiri-shared-utils || true
      
      - name: Node tests (deepiri-core-api)
        run: |
          cd deepiri-core-api
          npm test --silent || echo "Tests failed or not configured"
      
      - name: Security scan (Node - deepiri-core-api)
        run: |
          cd deepiri-core-api
          npm audit --production --audit-level=moderate || true
      
      - name: Security scan (Node - deepiri-web-frontend)
        run: |
          cd deepiri-web-frontend
          npm audit --production --audit-level=moderate || true
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Python deps and tests (diri-cyrex)
        run: |
          cd diri-cyrex
          pip install -r requirements.txt
          pytest -q || echo "Tests failed or not configured"
      
      - name: Security scan (Python)
        run: |
          python -m pip install pip-audit
          pip-audit || true
      
      - name: Docker build (deepiri-core-api)
        run: |
          docker build -t deepiri-core-api ./deepiri-core-api || echo "Docker build failed"
      
      - name: Docker build (diri-cyrex)
        run: |
          docker build -t diri-cyrex ./diri-cyrex || echo "Docker build failed"
      
      - name: Docker build (deepiri-web-frontend)
        run: |
          docker build -t deepiri-web-frontend ./deepiri-web-frontend || echo "Docker build failed"

