#!/bin/sh

# Pre-push hook to protect main, dev, master, and team-dev branches
# This hook receives ref information via stdin in the format:
# <local_ref> <local_sha1> <remote_ref> <remote_sha1>

# Base protected branches (always protected)
protected_branches="main dev master"

# Get repository name to check for team-dev branches
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
REPO_NAME=$(basename "$REPO_ROOT")

# If repo name ends with -team-dev, also protect that branch name
# Use -- to prevent grep from interpreting -t as an option
if echo "$REPO_NAME" | grep -qE -- '-team-dev$'; then
    protected_branches="$protected_branches $REPO_NAME"
fi

# Read the refs being pushed from stdin
while read local_ref local_sha remote_ref remote_sha; do
  # Extract branch name from ref (e.g., refs/heads/main -> main)
  branch_name=$(echo "$remote_ref" | sed 's|refs/heads/||')
  
  # Check if this branch is protected
  for protected in $protected_branches; do
    if [ "$branch_name" = "$protected" ]; then
      echo "‚ùå ERROR: You cannot push directly to '$protected'."
      echo "   Make a feature branch and use a Pull Request."
      echo "   Protected branches: $protected_branches"
      exit 1
    fi
  done
done

exit 0

